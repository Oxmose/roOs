\hypertarget{kheap_8h}{}\doxysection{Source/\+Kernel/\+Core/includes/kheap.h File Reference}
\label{kheap_8h}\index{Source/Kernel/Core/includes/kheap.h@{Source/Kernel/Core/includes/kheap.h}}
{\ttfamily \#include $<$stdint.\+h$>$}\newline
{\ttfamily \#include $<$stddef.\+h$>$}\newline
Include dependency graph for kheap.\+h\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=262pt]{kheap_8h__incl}
\end{center}
\end{figure}
This graph shows which files directly or indirectly include this file\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{kheap_8h__dep__incl}
\end{center}
\end{figure}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{kheap_8h_a34ef347a6500d98fc1c2034929c8244d}{kheap\+\_\+init}} (void)
\begin{DoxyCompactList}\small\item\em Initializes the kernel\textquotesingle{}s heap. \end{DoxyCompactList}\item 
void $\ast$ \mbox{\hyperlink{kheap_8h_a8279359d679aa29118d8f0b09e581947}{kmalloc}} (const \mbox{\hyperlink{stddef_8h_aa9d55e2f20e580b7445617d0d12fff6e}{size\+\_\+t}} size)
\begin{DoxyCompactList}\small\item\em Allocate memory from the kernel heap. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{kheap_8h_a069f85a5001d71bc44d8be6532a4e432}{kfree}} (void $\ast$ptr)
\begin{DoxyCompactList}\small\item\em Free allocated memory. \end{DoxyCompactList}\item 
\mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\+\_\+t}} \mbox{\hyperlink{kheap_8h_ababd7dca67c1bb349bd0a7e676347373}{kheap\+\_\+get\+\_\+free}} (void)
\begin{DoxyCompactList}\small\item\em Returns the kernel heap available memory. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{kheap_8h_a069f85a5001d71bc44d8be6532a4e432}\label{kheap_8h_a069f85a5001d71bc44d8be6532a4e432}} 
\index{kheap.h@{kheap.h}!kfree@{kfree}}
\index{kfree@{kfree}!kheap.h@{kheap.h}}
\doxysubsubsection{\texorpdfstring{kfree()}{kfree()}}
{\footnotesize\ttfamily void kfree (\begin{DoxyParamCaption}\item[{void $\ast$}]{ptr }\end{DoxyParamCaption})}



Free allocated memory. 

Releases allocated memory.\+IOf the pointer is NULL or has not been allocated previously from the heap, nothing is done.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em ptr} & The start address of the memory area to free. \\
\hline
\end{DoxyParams}


Definition at line 605 of file kheap.\+c.


\begin{DoxyCode}{0}
\DoxyCodeLine{606 \{}
\DoxyCodeLine{607     \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}}     used;}
\DoxyCodeLine{608     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* chunk;}
\DoxyCodeLine{609     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* next;}
\DoxyCodeLine{610     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* prev;}
\DoxyCodeLine{611     \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}}     int\_state;}
\DoxyCodeLine{612 }
\DoxyCodeLine{613     \textcolor{keywordflow}{if}(\mbox{\hyperlink{kheap_8c_ada161ed38a9174ff5b3a4f10b10fd238}{init}} == \mbox{\hyperlink{stdint_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}} || ptr == \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})}
\DoxyCodeLine{614     \{}
\DoxyCodeLine{615         \textcolor{keywordflow}{return};}
\DoxyCodeLine{616     \}}
\DoxyCodeLine{617 }
\DoxyCodeLine{618     \mbox{\hyperlink{i386_2includes_2critical_8h_a2022f694c4b84258f5a89536d07a3475}{ENTER\_CRITICAL}}(int\_state);}
\DoxyCodeLine{619 }
\DoxyCodeLine{620     chunk = (\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}*)((\mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}*)ptr -\/ \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}});}
\DoxyCodeLine{621     next = \mbox{\hyperlink{kheap_8c_aaf42941e72e1744957c3f655f98ae10a}{CONTAINER}}(\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}, all, chunk-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}}.\mbox{\hyperlink{structlist_a316ac2a777ad970368f874242890171e}{next}});}
\DoxyCodeLine{622     prev = \mbox{\hyperlink{kheap_8c_aaf42941e72e1744957c3f655f98ae10a}{CONTAINER}}(\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}, all, chunk-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}}.\mbox{\hyperlink{structlist_a31b2b1b9b2362fd1841e6d9949b26c81}{prev}});}
\DoxyCodeLine{623 }
\DoxyCodeLine{624     used = \mbox{\hyperlink{kheap_8c_ad25c392f9dbab023549ff379f8b4e370}{\_memory\_chunk\_size}}(chunk);}
\DoxyCodeLine{625 }
\DoxyCodeLine{626     \textcolor{keywordflow}{if} (next-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} == \mbox{\hyperlink{stdint_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}})}
\DoxyCodeLine{627     \{}
\DoxyCodeLine{628         \mbox{\hyperlink{kheap_8c_a94d4dd186b06bd6e36777080a99b2957}{\_remove\_free}}(next);}
\DoxyCodeLine{629         \mbox{\hyperlink{kheap_8c_afeb5803417a7390d3331bad7fa4cd6f7}{\_remove}}(\&next-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}});}
\DoxyCodeLine{630 }
\DoxyCodeLine{631         \mbox{\hyperlink{kheap_8c_a818f154b2f3d42e94229a6d034ceb644}{mem\_meta}} -\/= \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{632         \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} += \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{633     \}}
\DoxyCodeLine{634 }
\DoxyCodeLine{635     \textcolor{keywordflow}{if} (prev-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} == \mbox{\hyperlink{stdint_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}})}
\DoxyCodeLine{636     \{}
\DoxyCodeLine{637         \mbox{\hyperlink{kheap_8c_a94d4dd186b06bd6e36777080a99b2957}{\_remove\_free}}(prev);}
\DoxyCodeLine{638         \mbox{\hyperlink{kheap_8c_afeb5803417a7390d3331bad7fa4cd6f7}{\_remove}}(\&chunk-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}});}
\DoxyCodeLine{639 }
\DoxyCodeLine{640         \mbox{\hyperlink{kheap_8c_abd725f3c658de7bd1c84e20f8f88061d}{\_push\_free}}(prev);}
\DoxyCodeLine{641         \mbox{\hyperlink{kheap_8c_a818f154b2f3d42e94229a6d034ceb644}{mem\_meta}} -\/= \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{642         \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} += \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{643     \}}
\DoxyCodeLine{644     \textcolor{keywordflow}{else}}
\DoxyCodeLine{645     \{}
\DoxyCodeLine{646         chunk-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} = \mbox{\hyperlink{stdint_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}};}
\DoxyCodeLine{647         \mbox{\hyperlink{kheap_8c_ab6bc3dfaedd918bd6a990b7d4d657acc}{LIST\_INIT}}(chunk, free);}
\DoxyCodeLine{648         \mbox{\hyperlink{kheap_8c_abd725f3c658de7bd1c84e20f8f88061d}{\_push\_free}}(chunk);}
\DoxyCodeLine{649     \}}
\DoxyCodeLine{650 }
\DoxyCodeLine{651     \mbox{\hyperlink{kernel__output_8h_ad5a087734220dd655d1effaa240275fa}{KERNEL\_DEBUG}}(\mbox{\hyperlink{config_8h_abd082c0804abc6f2d1d3129fa3cef155}{KHEAP\_DEBUG\_ENABLED}}, \textcolor{stringliteral}{"{}KHEAP"{}},}
\DoxyCodeLine{652                  \textcolor{stringliteral}{"{}[KHEAP] Kheap freed 0x\%p -\/> \%uB"{}}, ptr, used);}
\DoxyCodeLine{653 }
\DoxyCodeLine{654 \textcolor{preprocessor}{\#ifdef ARCH\_64\_BITS}}
\DoxyCodeLine{655     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_FREE, 3,}
\DoxyCodeLine{656                        (uintptr\_t)ptr \& 0xFFFFFFFF,}
\DoxyCodeLine{657                        (uintptr\_t)ptr >> 32,}
\DoxyCodeLine{658                        \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{659 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{660     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_FREE, 3,}
\DoxyCodeLine{661                        (uintptr\_t)ptr \& 0xFFFFFFFF,}
\DoxyCodeLine{662                        (uintptr\_t)0,}
\DoxyCodeLine{663                        \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{664 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{665 }
\DoxyCodeLine{666     \mbox{\hyperlink{i386_2includes_2critical_8h_a0c9934639d2ec5b4c8c297c096a0d104}{EXIT\_CRITICAL}}(int\_state);}
\DoxyCodeLine{667 \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{kheap_8h_a069f85a5001d71bc44d8be6532a4e432_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{kheap_8h_a069f85a5001d71bc44d8be6532a4e432_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{kheap_8h_ababd7dca67c1bb349bd0a7e676347373}\label{kheap_8h_ababd7dca67c1bb349bd0a7e676347373}} 
\index{kheap.h@{kheap.h}!kheap\_get\_free@{kheap\_get\_free}}
\index{kheap\_get\_free@{kheap\_get\_free}!kheap.h@{kheap.h}}
\doxysubsubsection{\texorpdfstring{kheap\_get\_free()}{kheap\_get\_free()}}
{\footnotesize\ttfamily \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\+\_\+t}} kheap\+\_\+get\+\_\+free (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Returns the kernel heap available memory. 

Returns the kernel heap available memory.

\begin{DoxyReturn}{Returns}
The kernel heap available memory is returned. 
\end{DoxyReturn}


Definition at line 669 of file kheap.\+c.


\begin{DoxyCode}{0}
\DoxyCodeLine{670 \{}
\DoxyCodeLine{671     \textcolor{keywordflow}{return} \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}};}
\DoxyCodeLine{672 \}}

\end{DoxyCode}
\mbox{\Hypertarget{kheap_8h_a34ef347a6500d98fc1c2034929c8244d}\label{kheap_8h_a34ef347a6500d98fc1c2034929c8244d}} 
\index{kheap.h@{kheap.h}!kheap\_init@{kheap\_init}}
\index{kheap\_init@{kheap\_init}!kheap.h@{kheap.h}}
\doxysubsubsection{\texorpdfstring{kheap\_init()}{kheap\_init()}}
{\footnotesize\ttfamily void kheap\+\_\+init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Initializes the kernel\textquotesingle{}s heap. 

Setups kernel heap management. It will also allign kernel heap start and initialize the basic heap parameters such as its size. 

Definition at line 439 of file kheap.\+c.


\begin{DoxyCode}{0}
\DoxyCodeLine{440 \{}
\DoxyCodeLine{441     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* second;}
\DoxyCodeLine{442     \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}} len;}
\DoxyCodeLine{443     \mbox{\hyperlink{stdint_8h_a32f2e37ee053cf2ce8ca28d1f74630e5}{int32\_t}}  n;}
\DoxyCodeLine{444 }
\DoxyCodeLine{445     \textcolor{keywordtype}{void}* mem = \&\mbox{\hyperlink{kheap_8c_aa5611acaefaa4340432dbd56defedef8}{\_KERNEL\_HEAP\_BASE}};}
\DoxyCodeLine{446     \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}} size = (\mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}})(uintptr\_t)\&\mbox{\hyperlink{kheap_8c_aeb8393c9e5d0ffb3c77c82a86b2a8cb3}{\_KERNEL\_HEAP\_SIZE}};}
\DoxyCodeLine{447     \mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}* mem\_start = (\mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}*)}
\DoxyCodeLine{448                         (((uintptr\_t)mem + \mbox{\hyperlink{kheap_8c_ae4ff5a07c6ff43ed11a3887ef7d524f2}{ALIGN}} -\/ 1) \& (\string~(\mbox{\hyperlink{kheap_8c_ae4ff5a07c6ff43ed11a3887ef7d524f2}{ALIGN}} -\/ 1)));}
\DoxyCodeLine{449     \mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}* mem\_end = (\mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}*)(((uintptr\_t)mem + size) \& (\string~(\mbox{\hyperlink{kheap_8c_ae4ff5a07c6ff43ed11a3887ef7d524f2}{ALIGN}} -\/ 1)));}
\DoxyCodeLine{450 }
\DoxyCodeLine{451 \textcolor{preprocessor}{\#ifdef ARCH\_64\_BITS}}
\DoxyCodeLine{452     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_INIT\_START, 2,}
\DoxyCodeLine{453                        (uintptr\_t)mem \& 0xFFFFFFFF,}
\DoxyCodeLine{454                        (uintptr\_t)mem >> 32);}
\DoxyCodeLine{455 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{456     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_INIT\_START, 2,}
\DoxyCodeLine{457                        (uintptr\_t)mem \& 0xFFFFFFFF,}
\DoxyCodeLine{458                        (uintptr\_t)0);}
\DoxyCodeLine{459 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{460 }
\DoxyCodeLine{461     \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} = 0;}
\DoxyCodeLine{462     \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}} = 0;}
\DoxyCodeLine{463     \mbox{\hyperlink{kheap_8c_a818f154b2f3d42e94229a6d034ceb644}{mem\_meta}} = 0;}
\DoxyCodeLine{464     \mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}} = \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{465     \mbox{\hyperlink{kheap_8c_a40f5e900d4b369f4e9bb823c08d93caf}{last\_chunk}} = \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{466 }
\DoxyCodeLine{467     \mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}} = (\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}*)mem\_start;}
\DoxyCodeLine{468     second = \mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}} + 1;}
\DoxyCodeLine{469 }
\DoxyCodeLine{470     \mbox{\hyperlink{kheap_8c_a40f5e900d4b369f4e9bb823c08d93caf}{last\_chunk}} = ((\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}*)mem\_end) -\/ 1;}
\DoxyCodeLine{471 }
\DoxyCodeLine{472     \mbox{\hyperlink{kheap_8c_ae8a7c4debee323e4eeb1e06c90507780}{\_memory\_chunk\_init}}(\mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}});}
\DoxyCodeLine{473     \mbox{\hyperlink{kheap_8c_ae8a7c4debee323e4eeb1e06c90507780}{\_memory\_chunk\_init}}(second);}
\DoxyCodeLine{474 }
\DoxyCodeLine{475     \mbox{\hyperlink{kheap_8c_ae8a7c4debee323e4eeb1e06c90507780}{\_memory\_chunk\_init}}(\mbox{\hyperlink{kheap_8c_a40f5e900d4b369f4e9bb823c08d93caf}{last\_chunk}});}
\DoxyCodeLine{476     \mbox{\hyperlink{kheap_8c_a5720eb7da9d70aff0c14a371bf9f444c}{\_insert\_after}}(\&\mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}}-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}}, \&second-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}});}
\DoxyCodeLine{477     \mbox{\hyperlink{kheap_8c_a5720eb7da9d70aff0c14a371bf9f444c}{\_insert\_after}}(\&second-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}}, \&\mbox{\hyperlink{kheap_8c_a40f5e900d4b369f4e9bb823c08d93caf}{last\_chunk}}-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}});}
\DoxyCodeLine{478 }
\DoxyCodeLine{479     \mbox{\hyperlink{kheap_8c_a5bab399ba10394e05532e160c792927c}{first\_chunk}}-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} = \mbox{\hyperlink{stdint_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}};}
\DoxyCodeLine{480     \mbox{\hyperlink{kheap_8c_a40f5e900d4b369f4e9bb823c08d93caf}{last\_chunk}}-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} = \mbox{\hyperlink{stdint_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}};}
\DoxyCodeLine{481 }
\DoxyCodeLine{482     len = \mbox{\hyperlink{kheap_8c_ad25c392f9dbab023549ff379f8b4e370}{\_memory\_chunk\_size}}(second);}
\DoxyCodeLine{483     n   = \mbox{\hyperlink{kheap_8c_ae110f6374ef6cc5abaa5b28ec8b56a6c}{\_memory\_chunk\_slot}}(len);}
\DoxyCodeLine{484 }
\DoxyCodeLine{485     \mbox{\hyperlink{kheap_8c_ab31501c856704e2e138b6216a690e658}{LIST\_PUSH}}(\&\mbox{\hyperlink{kheap_8c_ae05237f434a34b9c8cb95c0b0bff5b54}{free\_chunk}}[n], second, free);}
\DoxyCodeLine{486     \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} = len;}
\DoxyCodeLine{487     \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}} = \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}};}
\DoxyCodeLine{488     \mbox{\hyperlink{kheap_8c_a818f154b2f3d42e94229a6d034ceb644}{mem\_meta}} = \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}) * 2 + \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{489 }
\DoxyCodeLine{490     \mbox{\hyperlink{kheap_8c_ada161ed38a9174ff5b3a4f10b10fd238}{init}} = \mbox{\hyperlink{stdint_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}};}
\DoxyCodeLine{491 }
\DoxyCodeLine{492     \mbox{\hyperlink{kernel__output_8h_ad5a087734220dd655d1effaa240275fa}{KERNEL\_DEBUG}}(\mbox{\hyperlink{config_8h_abd082c0804abc6f2d1d3129fa3cef155}{KHEAP\_DEBUG\_ENABLED}}, \textcolor{stringliteral}{"{}KHEAP"{}},}
\DoxyCodeLine{493                  \textcolor{stringliteral}{"{}Kernel Heap Initialized at 0x\%p"{}}, mem\_start);}
\DoxyCodeLine{494 }
\DoxyCodeLine{495 \textcolor{preprocessor}{\#ifdef ARCH\_64\_BITS}}
\DoxyCodeLine{496     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_INIT\_END, 3,}
\DoxyCodeLine{497                        (uintptr\_t)mem \& 0xFFFFFFFF,}
\DoxyCodeLine{498                        (uintptr\_t)mem >> 32,}
\DoxyCodeLine{499                        \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}});}
\DoxyCodeLine{500 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{501     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_INIT\_END, 3,}
\DoxyCodeLine{502                        (uintptr\_t)mem \& 0xFFFFFFFF,}
\DoxyCodeLine{503                        (uintptr\_t)0,}
\DoxyCodeLine{504                        \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}});}
\DoxyCodeLine{505 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{506 }
\DoxyCodeLine{507     \mbox{\hyperlink{test__framework_8h_a41ccebea0fb21bcf77ae2e3c16d2968e}{TEST\_POINT\_FUNCTION\_CALL}}(\mbox{\hyperlink{test__list_8h_a2423c0ed7b6dead22d05869967d82c41}{kheap\_test}}, \mbox{\hyperlink{test__list_8h_a6caa622cb4bd58687176f72deb7fa6ba}{TEST\_KHEAP\_ENABLED}});}
\DoxyCodeLine{508 \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=306pt]{kheap_8h_a34ef347a6500d98fc1c2034929c8244d_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=243pt]{kheap_8h_a34ef347a6500d98fc1c2034929c8244d_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{kheap_8h_a8279359d679aa29118d8f0b09e581947}\label{kheap_8h_a8279359d679aa29118d8f0b09e581947}} 
\index{kheap.h@{kheap.h}!kmalloc@{kmalloc}}
\index{kmalloc@{kmalloc}!kheap.h@{kheap.h}}
\doxysubsubsection{\texorpdfstring{kmalloc()}{kmalloc()}}
{\footnotesize\ttfamily void$\ast$ kmalloc (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{stddef_8h_aa9d55e2f20e580b7445617d0d12fff6e}{size\+\_\+t}}}]{size }\end{DoxyParamCaption})}



Allocate memory from the kernel heap. 

Allocate a chunk of memory form the kernel heap and returns the start address of the chunk.

­
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em size} & The number of byte to allocate.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A pointer to the start address of the allocated memory is returned. If the memory cannot be allocated, this pointer will be NULL. 
\end{DoxyReturn}


Definition at line 510 of file kheap.\+c.


\begin{DoxyCode}{0}
\DoxyCodeLine{511 \{}
\DoxyCodeLine{512     \textcolor{keywordtype}{size\_t}       n;}
\DoxyCodeLine{513     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* chunk;}
\DoxyCodeLine{514     \mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}* chunk2;}
\DoxyCodeLine{515     \textcolor{keywordtype}{size\_t}       size2;}
\DoxyCodeLine{516     \textcolor{keywordtype}{size\_t}       len;}
\DoxyCodeLine{517     \mbox{\hyperlink{stdint_8h_a324c5d28c0d82f502a234ab99efac87a}{uint32\_t}}     int\_state;}
\DoxyCodeLine{518 }
\DoxyCodeLine{519     \mbox{\hyperlink{kernel__output_8h_ad5a087734220dd655d1effaa240275fa}{KERNEL\_DEBUG}}(\mbox{\hyperlink{config_8h_abd082c0804abc6f2d1d3129fa3cef155}{KHEAP\_DEBUG\_ENABLED}}, \textcolor{stringliteral}{"{}KHEAP"{}},}
\DoxyCodeLine{520                  \textcolor{stringliteral}{"{}Kheap allocating \%uB (\%uB free, \%uB used)"{}},}
\DoxyCodeLine{521                  size, \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}},}
\DoxyCodeLine{522                  \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}} -\/ \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{523 }
\DoxyCodeLine{524     \textcolor{keywordflow}{if}(\mbox{\hyperlink{kheap_8c_ada161ed38a9174ff5b3a4f10b10fd238}{init}} == \mbox{\hyperlink{stdint_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}} || size == 0)}
\DoxyCodeLine{525     \{}
\DoxyCodeLine{526         \textcolor{keywordflow}{return} \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{527     \}}
\DoxyCodeLine{528 }
\DoxyCodeLine{529     \mbox{\hyperlink{i386_2includes_2critical_8h_a2022f694c4b84258f5a89536d07a3475}{ENTER\_CRITICAL}}(int\_state);}
\DoxyCodeLine{530 }
\DoxyCodeLine{531     size = (size + \mbox{\hyperlink{kheap_8c_ae4ff5a07c6ff43ed11a3887ef7d524f2}{ALIGN}} -\/ 1) \& (\string~(\mbox{\hyperlink{kheap_8c_ae4ff5a07c6ff43ed11a3887ef7d524f2}{ALIGN}} -\/ 1));}
\DoxyCodeLine{532 }
\DoxyCodeLine{533     \textcolor{keywordflow}{if} (size < \mbox{\hyperlink{kheap_8c_a278694c2333c9826f21ddd2c2d220f66}{MIN\_SIZE}})}
\DoxyCodeLine{534     \{}
\DoxyCodeLine{535          size = \mbox{\hyperlink{kheap_8c_a278694c2333c9826f21ddd2c2d220f66}{MIN\_SIZE}};}
\DoxyCodeLine{536     \}}
\DoxyCodeLine{537 }
\DoxyCodeLine{538     n = \mbox{\hyperlink{kheap_8c_ae110f6374ef6cc5abaa5b28ec8b56a6c}{\_memory\_chunk\_slot}}(size -\/ 1) + 1;}
\DoxyCodeLine{539 }
\DoxyCodeLine{540     \textcolor{keywordflow}{if} (n >= \mbox{\hyperlink{kheap_8c_a8c38ad43f5e558ed28297fe9d151949f}{NUM\_SIZES}})}
\DoxyCodeLine{541     \{}
\DoxyCodeLine{542         \mbox{\hyperlink{i386_2includes_2critical_8h_a0c9934639d2ec5b4c8c297c096a0d104}{EXIT\_CRITICAL}}(int\_state);}
\DoxyCodeLine{543         \textcolor{keywordflow}{return} \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{544     \}}
\DoxyCodeLine{545 }
\DoxyCodeLine{546     \textcolor{keywordflow}{while}(\mbox{\hyperlink{kheap_8c_ae05237f434a34b9c8cb95c0b0bff5b54}{free\_chunk}}[n] == 0)}
\DoxyCodeLine{547     \{}
\DoxyCodeLine{548         ++n;}
\DoxyCodeLine{549         \textcolor{keywordflow}{if} (n >= \mbox{\hyperlink{kheap_8c_a8c38ad43f5e558ed28297fe9d151949f}{NUM\_SIZES}})}
\DoxyCodeLine{550         \{}
\DoxyCodeLine{551             \mbox{\hyperlink{i386_2includes_2critical_8h_a0c9934639d2ec5b4c8c297c096a0d104}{EXIT\_CRITICAL}}(int\_state);}
\DoxyCodeLine{552             \textcolor{keywordflow}{return} \mbox{\hyperlink{stddef_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{553         \}}
\DoxyCodeLine{554     \}}
\DoxyCodeLine{555 }
\DoxyCodeLine{556     chunk = \mbox{\hyperlink{kheap_8c_ab96a3fffefb88de5950967fd340bfd7b}{LIST\_POP}}(\&\mbox{\hyperlink{kheap_8c_ae05237f434a34b9c8cb95c0b0bff5b54}{free\_chunk}}[n], free);}
\DoxyCodeLine{557     size2 = \mbox{\hyperlink{kheap_8c_ad25c392f9dbab023549ff379f8b4e370}{\_memory\_chunk\_size}}(chunk);}
\DoxyCodeLine{558     len = 0;}
\DoxyCodeLine{559 }
\DoxyCodeLine{560     \textcolor{keywordflow}{if} (size + \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}) <= size2)}
\DoxyCodeLine{561     \{}
\DoxyCodeLine{562         chunk2 = (\mbox{\hyperlink{structmem__chunk__t}{mem\_chunk\_t}}*)(((\mbox{\hyperlink{stdint_8h_aef44329758059c91c76d334e8fc09700}{int8\_t}}*)chunk) + \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}} + size);}
\DoxyCodeLine{563 }
\DoxyCodeLine{564         \mbox{\hyperlink{kheap_8c_ae8a7c4debee323e4eeb1e06c90507780}{\_memory\_chunk\_init}}(chunk2);}
\DoxyCodeLine{565 }
\DoxyCodeLine{566         \mbox{\hyperlink{kheap_8c_a5720eb7da9d70aff0c14a371bf9f444c}{\_insert\_after}}(\&chunk-\/>all, \&chunk2-\/>\mbox{\hyperlink{structmem__chunk__t_a9e91af790d9ded5d541d57b9b30e5ef2}{all}});}
\DoxyCodeLine{567 }
\DoxyCodeLine{568         len = \mbox{\hyperlink{kheap_8c_ad25c392f9dbab023549ff379f8b4e370}{\_memory\_chunk\_size}}(chunk2);}
\DoxyCodeLine{569         n = \mbox{\hyperlink{kheap_8c_ae110f6374ef6cc5abaa5b28ec8b56a6c}{\_memory\_chunk\_slot}}(len);}
\DoxyCodeLine{570 }
\DoxyCodeLine{571         \mbox{\hyperlink{kheap_8c_ab31501c856704e2e138b6216a690e658}{LIST\_PUSH}}(\&\mbox{\hyperlink{kheap_8c_ae05237f434a34b9c8cb95c0b0bff5b54}{free\_chunk}}[n], chunk2, free);}
\DoxyCodeLine{572 }
\DoxyCodeLine{573         \mbox{\hyperlink{kheap_8c_a818f154b2f3d42e94229a6d034ceb644}{mem\_meta}} += \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}};}
\DoxyCodeLine{574         \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} += len;}
\DoxyCodeLine{575     \}}
\DoxyCodeLine{576 }
\DoxyCodeLine{577     chunk-\/>\mbox{\hyperlink{structmem__chunk__t_a33a790083c6334e6715465a66d3e174e}{used}} = \mbox{\hyperlink{stdint_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}};}
\DoxyCodeLine{578 }
\DoxyCodeLine{579     \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}} -\/= size2;}
\DoxyCodeLine{580 }
\DoxyCodeLine{581     \mbox{\hyperlink{kernel__output_8h_ad5a087734220dd655d1effaa240275fa}{KERNEL\_DEBUG}}(\mbox{\hyperlink{config_8h_abd082c0804abc6f2d1d3129fa3cef155}{KHEAP\_DEBUG\_ENABLED}}, \textcolor{stringliteral}{"{}KHEAP"{}},}
\DoxyCodeLine{582                  \textcolor{stringliteral}{"{}Kheap allocated 0x\%p -\/> \%uB (\%uB free, \%uB used)"{}},}
\DoxyCodeLine{583                  chunk-\/>\mbox{\hyperlink{structmem__chunk__t_abe222f6d3581e7920dcad5306cc906a8}{data}}, size2 -\/ len -\/ \mbox{\hyperlink{kheap_8c_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}, \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}},}
\DoxyCodeLine{584                  \mbox{\hyperlink{kheap_8c_af5ec787aa92fe3d283d6897f3ee0e4a0}{kheap\_init\_free}} -\/ \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{585 }
\DoxyCodeLine{586     \mbox{\hyperlink{i386_2includes_2critical_8h_a0c9934639d2ec5b4c8c297c096a0d104}{EXIT\_CRITICAL}}(int\_state);}
\DoxyCodeLine{587 }
\DoxyCodeLine{588 \textcolor{preprocessor}{\#ifdef ARCH\_64\_BITS}}
\DoxyCodeLine{589     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_ALLOC, 4,}
\DoxyCodeLine{590                        (uintptr\_t)chunk-\/>\mbox{\hyperlink{structmem__chunk__t_abe222f6d3581e7920dcad5306cc906a8}{data}} \& 0xFFFFFFFF,}
\DoxyCodeLine{591                        (uintptr\_t)chunk-\/>\mbox{\hyperlink{structmem__chunk__t_abe222f6d3581e7920dcad5306cc906a8}{data}} >> 32,}
\DoxyCodeLine{592                        size,}
\DoxyCodeLine{593                        \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{594 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{595     \mbox{\hyperlink{tracing_8h_a631034fc8d54090aa7f8fca47f5f4d58}{KERNEL\_TRACE\_EVENT}}(EVENT\_KERNEL\_HEAP\_ALLOC, 4,}
\DoxyCodeLine{596                        (uintptr\_t)chunk-\/>\mbox{\hyperlink{structmem__chunk__t_abe222f6d3581e7920dcad5306cc906a8}{data}} \& 0xFFFFFFFF,}
\DoxyCodeLine{597                        (uintptr\_t)0,}
\DoxyCodeLine{598                        size,}
\DoxyCodeLine{599                        \mbox{\hyperlink{kheap_8c_a018ca54b4009ff9bf2dce3333d3d2b56}{mem\_free}});}
\DoxyCodeLine{600 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{601 }
\DoxyCodeLine{602     \textcolor{keywordflow}{return} chunk-\/>\mbox{\hyperlink{structmem__chunk__t_abe222f6d3581e7920dcad5306cc906a8}{data}};}
\DoxyCodeLine{603 \}}

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=294pt]{kheap_8h_a8279359d679aa29118d8f0b09e581947_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{kheap_8h_a8279359d679aa29118d8f0b09e581947_icgraph}
\end{center}
\end{figure}
