;-------------------------------------------------------------------------------
;
; File: cpu_sync.S
;
; Author: Alexy Torres Aurora Dugo
;
; Date: 25/04/2023
;
; Version: 1.0
;
; CPU synchronization functions
;-------------------------------------------------------------------------------
;-------------------------------------------------------------------------------
; ARCH
;-------------------------------------------------------------------------------
[bits 64]

;-------------------------------------------------------------------------------
; DEFINES
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; MACRO DEFINE
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXTERN DATA
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXTERN FUNCTIONS
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXPORTED FUNCTIONS
;-------------------------------------------------------------------------------
global spinlockAcquire
global spinlockRelease
global atomicIncrement32
global atomicDecrement32

;-------------------------------------------------------------------------------
; CODE
;-------------------------------------------------------------------------------

section .text
;-------------------------------------------------------------------------------
; Lock Spinlock
;
; Param:
;     Input: rdi: Address of the lock

spinlockAcquire:
__pauseSpinlockEntry:
    lock bts dword [rdi], 0
    jc   __pauseSpinlockPause
    ret

__pauseSpinlockPause:
    pause
    test  dword [rdi], 1
    jnz   __pauseSpinlockPause
    jmp   __pauseSpinlockEntry

;-------------------------------------------------------------------------------
; Unlock Spinlock
;
; Param:
;     Input: rdi: Address of the lock

spinlockRelease:
    mov  dword [rdi], 0
    ret

;-------------------------------------------------------------------------------
; 32 Bits atomic increment
;
; Param:
;     Input: rdi: u32_atomic_t value to increment
atomicIncrement32:
    mov  eax, 1
    lock xadd dword [rdi], eax
    ret

;-------------------------------------------------------------------------------
; 32 Bits atomic decrement
;
; Param:
;     Input: rdi: u32_atomic_t value to decrement
atomicDecrement32:
    mov  eax, -1
    lock xadd dword [rdi], eax
    ret

;-------------------------------------------------------------------------------
; DATA
;-------------------------------------------------------------------------------

;************************************ EOF **************************************